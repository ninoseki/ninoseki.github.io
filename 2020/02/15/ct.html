<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Gleaning on Certificate Transparency (or how CertStream is improved) | ninoseki.github.io</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="alternate" type="application/rss+xml" href="https://ninoseki.github.io/rss.xml" title="ninoseki.github.io RSS Feed">
    <link rel="alternate" type="application/atom+xml" href="https://ninoseki.github.io/feed.atom" title="ninoseki.github.io Atom Feed">
    <link rel="alternate" type="application/json" href="https://ninoseki.github.io/feed.json" title="ninoseki.github.io JSON Feed">
    <meta name="description" content="(â—__â—)">
    <meta name="twitter:image">
    <meta property="og:url" content="https://ninoseki.github.io/_posts/2020-02-15-ct.html">
    <meta name="twitter:url" content="https://ninoseki.github.io/_posts/2020-02-15-ct.html">
    <meta property="og:title" content="Gleaning on Certificate Transparency (or how CertStream is improved)">
    <meta name="twitter:title" content="Gleaning on Certificate Transparency (or how CertStream is improved)">
    <meta itemprop="name" content="Gleaning on Certificate Transparency (or how CertStream is improved)">
    <meta property="og:type" content="article">
    <meta name="twitter:card" content="summary">
    <meta property="og:site_name" content="ninoseki.github.io">
    
    <link rel="preload" href="/assets/css/0.styles.0313a152.css" as="style"><link rel="preload" href="/assets/js/app.c8db5b8a.js" as="script"><link rel="preload" href="/assets/js/2.551672f8.js" as="script"><link rel="preload" href="/assets/js/23.ed0bd195.js" as="script"><link rel="prefetch" href="/assets/js/10.93b31ecf.js"><link rel="prefetch" href="/assets/js/11.c7100068.js"><link rel="prefetch" href="/assets/js/12.581a6cb7.js"><link rel="prefetch" href="/assets/js/13.4a900d3a.js"><link rel="prefetch" href="/assets/js/14.35bc31c5.js"><link rel="prefetch" href="/assets/js/15.0c5932bf.js"><link rel="prefetch" href="/assets/js/16.299d6e84.js"><link rel="prefetch" href="/assets/js/17.bce521f0.js"><link rel="prefetch" href="/assets/js/18.27e8b041.js"><link rel="prefetch" href="/assets/js/19.e0c00b92.js"><link rel="prefetch" href="/assets/js/20.26e859db.js"><link rel="prefetch" href="/assets/js/21.b30f15e1.js"><link rel="prefetch" href="/assets/js/22.448af522.js"><link rel="prefetch" href="/assets/js/24.ab2bb9e9.js"><link rel="prefetch" href="/assets/js/25.2c17fb30.js"><link rel="prefetch" href="/assets/js/26.5c975520.js"><link rel="prefetch" href="/assets/js/27.53eefe9e.js"><link rel="prefetch" href="/assets/js/28.989fe98b.js"><link rel="prefetch" href="/assets/js/29.ad8c9bc4.js"><link rel="prefetch" href="/assets/js/3.78dae79f.js"><link rel="prefetch" href="/assets/js/30.397b4d86.js"><link rel="prefetch" href="/assets/js/31.924c0225.js"><link rel="prefetch" href="/assets/js/32.13b6de82.js"><link rel="prefetch" href="/assets/js/33.27cd3ddf.js"><link rel="prefetch" href="/assets/js/34.134325a9.js"><link rel="prefetch" href="/assets/js/35.7dc97dee.js"><link rel="prefetch" href="/assets/js/4.7d7fb440.js"><link rel="prefetch" href="/assets/js/5.b3da5054.js"><link rel="prefetch" href="/assets/js/6.5cee6874.js"><link rel="prefetch" href="/assets/js/7.1f1d02f6.js"><link rel="prefetch" href="/assets/js/8.b26ffa7b.js"><link rel="prefetch" href="/assets/js/9.79bb7ce1.js">
    <link rel="stylesheet" href="/assets/css/0.styles.0313a152.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">ninoseki.github.io</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/about/" class="nav-link">
  About
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/about/" class="nav-link">
  About
</a></div> <!----></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="page-title"><a href="#page-title" class="header-anchor">#</a> Gleaning on Certificate Transparency (or how CertStream is improved)</h1> <p><span style="color:#999;">5 min read...</span></p> <h2 id="what-is-certificate-transparency"><a href="#what-is-certificate-transparency" class="header-anchor">#</a> What is Certificate Transparency</h2> <p>Certificate Transparency (CT) is a protocol for recording and reviewing certificate issuance.</p> <p>CT is developed by Google to audit SSL certificates in real time and it is also used for threat hunting. (E.g. phishing detection)</p> <ul><li><a href="https://www.certificate-transparency.org/" target="_blank" rel="noopener noreferrer">Google's Certificate Transparency project<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p><img src="https://i.imgur.com/hYTbYns.png" alt=""></p> <h2 id="how-to-get-ct-logs-from-a-ct-log-server"><a href="#how-to-get-ct-logs-from-a-ct-log-server" class="header-anchor">#</a> How to get CT logs from a CT log server</h2> <p>Let's take Google's Xenon2020 (https://ct.googleapis.com/logs/xenon2020/) as an example.</p> <p>First, you have to know the tree size of the CT log server.</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">date</span> <span class="token parameter variable">-u</span>
Fri Feb <span class="token number">14</span> 01:53:42 UTC <span class="token number">2020</span>

$ <span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token string">&quot;https://ct.googleapis.com/logs/xenon2020/ct/v1/get-sth&quot;</span> <span class="token operator">|</span> jq <span class="token string">&quot;.tree_size&quot;</span>
<span class="token number">311353005</span>
</code></pre></div><p>It means Xenon2020 has 311,353,005 entries at that moment.</p> <p>Let's get the last 2 entries from Xenon2020.</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token string">&quot;https://ct.googleapis.com/logs/xenon2020/ct/v1/get-entries?start=311353004&amp;end=311353005&quot;</span> <span class="token operator">|</span> jq
<span class="token punctuation">{</span>
  <span class="token string">&quot;entries&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">&quot;leaf_input&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;AAAAAAFwQWY9YgAB3kcNJzkUJ1RqMXJzFX4Zxux5WfETK+uL6Viq9lJNn4oAA6QwggOgoAMCAQICEAVOX6FwA+h3QyeNVDYhzuEwCgYIKoZIzj0EAwIwbzELMAkGA1UEBhMCVVMxCzAJBgNVBAgTAkNBMRYwFAYDVQQHEw1TYW4gRnJhbmNpc2NvMRkwFwYDVQQKExBDbG91ZEZsYXJlLCBJbmMuMSAwHgYDVQQDExdDbG91ZEZsYXJlIEluYyBFQ0MgQ0EtMjAeFw0yMDAyMTQwMDAwMDBaFw0yMDEwMDkxMjAwMDBaMG0xCzAJBgNVBAYTAlVTMQswCQYDVQQIEwJDQTEWMBQGA1UEBxMNU2FuIEZyYW5jaXNjbzEZMBcGA1UEChMQQ2xvdWRmbGFyZSwgSW5jLjEeMBwGA1UEAxMVc25pLmNsb3VkZmxhcmVzc2wuY29tMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEfOKEWIol6moTYRxu5dVbnFVg7lMmS+AiGikzLhN6i581o93v0so+LhfVPJTzJbk39fR+opiGVALnlU0RgIeeNKOCAh4wggIaMB8GA1UdIwQYMBaAFD50LR/PRXUEfj/Aooc+TEODURPGMB0GA1UdDgQWBBTjMLpbQPsIuYT9mqqymvmeM1wJwDBaBgNVHREEUzBRghwqLm5hdGlvbmFscGV0YXNzb2NpYXRpb24uY29tghpuYXRpb25hbHBldGFzc29jaWF0aW9uLmNvbYIVc25pLmNsb3VkZmxhcmVzc2wuY29tMA4GA1UdDwEB/wQEAwIHgDAdBgNVHSUEFjAUBggrBgEFBQcDAQYIKwYBBQUHAwIweQYDVR0fBHIwcDA2oDSgMoYwaHR0cDovL2NybDMuZGlnaWNlcnQuY29tL0Nsb3VkRmxhcmVJbmNFQ0NDQTIuY3JsMDagNKAyhjBodHRwOi8vY3JsNC5kaWdpY2VydC5jb20vQ2xvdWRGbGFyZUluY0VDQ0NBMi5jcmwwTAYDVR0gBEUwQzA3BglghkgBhv1sAQEwKjAoBggrBgEFBQcCARYcaHR0cHM6Ly93d3cuZGlnaWNlcnQuY29tL0NQUzAIBgZngQwBAgIwdgYIKwYBBQUHAQEEajBoMCQGCCsGAQUFBzABhhhodHRwOi8vb2NzcC5kaWdpY2VydC5jb20wQAYIKwYBBQUHMAKGNGh0dHA6Ly9jYWNlcnRzLmRpZ2ljZXJ0LmNvbS9DbG91ZEZsYXJlSW5jRUNDQ0EtMi5jcnQwDAYDVR0TAQH/BAIwAAAA&quot;</span>,
      <span class="token string">&quot;extra_data&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;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&quot;</span>
    <span class="token punctuation">}</span>,
    <span class="token punctuation">{</span>
      <span class="token string">&quot;leaf_input&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;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&quot;</span>,
      <span class="token string">&quot;extra_data&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;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&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>leaf_input</code> is a base64-encoded <a href="https://tools.ietf.org/html/rfc6962#section-3.4" target="_blank" rel="noopener noreferrer">MerkleTreeLeaf<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> structure and <code>extra_data</code> is a base64-encoded <a href="https://tools.ietf.org/html/rfc6962#section-3.1" target="_blank" rel="noopener noreferrer">PrecertChainEntry<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> structure.</p> <p>You don't have to know the details of the structures because there are many libraries to deal with them.</p> <p>In Ruby, you can use <code>certificate-transparency</code> gem.</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token keyword">require</span> <span class="token string-literal"><span class="token string">&quot;certificate-transparency&quot;</span></span>
<span class="token keyword">require</span> <span class="token string-literal"><span class="token string">&quot;http&quot;</span></span>
<span class="token keyword">require</span> <span class="token string-literal"><span class="token string">&quot;json&quot;</span></span>

url <span class="token operator">=</span> <span class="token string-literal"><span class="token string">&quot;https://ct.googleapis.com/logs/xenon2020/ct/v1/get-entries?start=311353004&amp;end=311353005&quot;</span></span>
res <span class="token operator">=</span> <span class="token constant">HTTP</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
json <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span>parse<span class="token punctuation">(</span>res<span class="token punctuation">.</span>body<span class="token punctuation">.</span>to_s<span class="token punctuation">)</span>

entries <span class="token operator">=</span> <span class="token punctuation">(</span>json<span class="token punctuation">.</span>dig<span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;entries&quot;</span></span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>map <span class="token keyword">do</span> <span class="token operator">|</span>entry<span class="token operator">|</span>
  <span class="token constant">CT</span><span class="token double-colon punctuation">::</span>LogEntry<span class="token punctuation">.</span>from_json entry<span class="token punctuation">.</span>to_json
<span class="token keyword">end</span>

p entries<span class="token punctuation">.</span>first
<span class="token comment"># =&gt; #&lt;CertificateTransparency::LogEntry:0x00007fb50fad6440</span>
<span class="token comment">#  @certificate_chain=</span>
<span class="token comment">#   #&lt;CertificateTransparency::CertificateChain:0x00007fb50fad4c08</span>
<span class="token comment">#    @chain=</span>
<span class="token comment">#     [#&lt;OpenSSL::X509::Certificate</span>
<span class="token comment">#       subject=#&lt;OpenSSL::X509::Name CN=CloudFlare Inc ECC CA-2,O=CloudFlare\, Inc.,L=San Francisco,ST=CA,C=US&gt;,</span>
<span class="token comment">#       issuer=#&lt;OpenSSL::X509::Name CN=Baltimore CyberTrust Root,OU=CyberTrust,O=Baltimore,C=IE&gt;,</span>
<span class="token comment">#       serial=#&lt;OpenSSL::BN 21204814788472567899750642361434432950&gt;,</span>
<span class="token comment">#       not_before=2015-10-14 12:00:00 UTC,</span>
<span class="token comment">#       not_after=2020-10-09 12:00:00 UTC&gt;,</span>
<span class="token comment">#      #&lt;OpenSSL::X509::Certificate</span>
<span class="token comment">#       subject=#&lt;OpenSSL::X509::Name CN=Baltimore CyberTrust Root,OU=CyberTrust,O=Baltimore,C=IE&gt;,</span>
<span class="token comment">#       issuer=#&lt;OpenSSL::X509::Name CN=Baltimore CyberTrust Root,OU=CyberTrust,O=Baltimore,C=IE&gt;,</span>
<span class="token comment">#       serial=#&lt;OpenSSL::BN 33554617&gt;,</span>
<span class="token comment">#       not_before=2000-05-12 18:46:00 UTC,</span>
<span class="token comment">#       not_after=2025-05-12 23:59:00 UTC&gt;]&gt;,</span>
<span class="token comment">#  @leaf_input=</span>
<span class="token comment">#   #&lt;CertificateTransparency::MerkleTreeLeaf:0x00007fb50fad6378</span>
<span class="token comment">#    @leaf_type=0,</span>
<span class="token comment">#    @timestamped_entry=</span>
<span class="token comment">#     #&lt;CertificateTransparency::TimestampedEntry:0x00007fb50fad6170</span>
<span class="token comment">#      @entry_type=:precert_entry,</span>
<span class="token comment">#      @precert_entry=</span>
<span class="token comment">#       #&lt;CertificateTransparency::PreCert:0x00007fb50fad5cc0</span>
<span class="token comment">#        @issuer_key_hash=&quot;\xDEG\r'9\x14'Tj1rs\x15~\x19\xC6\xECyY\xF1\x13+\xEB\x8B\xE9X\xAA\xF6RM\x9F\x8A&quot;,</span>
<span class="token comment">#        @tbs_certificate=</span>
<span class="token comment">#         &quot;0\x82\x03\xA0\xA0\x03\x02\x01\x02\x02\x10\x05N_\xA1p\x03\xE8wC'\x8DT6!\xCE\xE10\n\x06\b*\x86H\xCE=\x04\x03\x020o1\v0\t\x06\x03U\x04\x06\x13\x02US1\v0\t\x06\x03U\x04\b\x13\x02CA1\x160\x14\x06\x03U\x04\a\x13\rSan Francisco1\x190\x17\x06\x03U\x04\n\x13\x10CloudFlare, Inc.1 0\x1E\x06\x03U\x04\x03\x13\x17CloudFlare Inc ECC CA-20\x1E\x17\r200214000000Z\x17\r201009120000Z0m1\v0\t\x06\x03U\x04\x06\x13\x02US1\v0\t\x06\x03U\x04\b\x13\x02CA1\x160\x14\x06\x03U\x04\a\x13\rSan Francisco1\x190\x17\x06\x03U\x04\n\x13\x10Cloudflare, Inc.1\x1E0\x1C\x06\x03U\x04\x03\x13\x15sni.cloudflaressl.com0Y0\x13\x06\a*\x86H\xCE=\x02\x01\x06\b*\x86H\xCE=\x03\x01\a\x03B\x00\x04|\xE2\x84X\x8A%\xEAj\x13a\x1Cn\xE5\xD5[\x9CU`\xEES&amp;K\xE0\&quot;\x1A)3.\x13z\x8B\x9F5\xA3\xDD\xEF\xD2\xCA&gt;.\x17\xD5&lt;\x94\xF3%\xB97\xF5\xF4~\xA2\x98\x86T\x02\xE7\x95M\x11\x80\x87\x9E4\xA3\x82\x02\x1E0\x82\x02\x1A0\x1F\x06\x03U\x1D#\x04\x180\x16\x80\x14&gt;t-\x1F\xCFEu\x04~?\xC0\xA2\x87&gt;LC\x83Q\x13\xC60\x1D\x06\x03U\x1D\x0E\x04\x16\x04\x14\xE30\xBA[@\xFB\b\xB9\x84\xFD\x9A\xAA\xB2\x9A\xF9\x9E3\\\t\xC00Z\x06\x03U\x1D\x11\x04S0Q\x82\x1C*.nationalpetassociation.com\x82\x1Anationalpetassociation.com\x82\x15sni.cloudflaressl.com0\x0E\x06\x03U\x1D\x0F\x01\x01\xFF\x04\x04\x03\x02\a\x800\x1D\x06\x03U\x1D%\x04\x160\x14\x06\b+\x06\x01\x05\x05\a\x03\x01\x06\b+\x06\x01\x05\x05\a\x03\x020y\x06\x03U\x1D\x1F\x04r0p06\xA04\xA02\x860http://crl3.digicert.com/CloudFlareIncECCCA2.crl06\xA04\xA02\x860http://crl4.digicert.com/CloudFlareIncECCCA2.crl0L\x06\x03U\x1D \x04E0C07\x06\t`\x86H\x01\x86\xFDl\x01\x010*0(\x06\b+\x06\x01\x05\x05\a\x02\x01\x16\x1Chttps://www.digicert.com/CPS0\b\x06\x06g\x81\f\x01\x02\x020v\x06\b+\x06\x01\x05\x05\a\x01\x01\x04j0h0$\x06\b+\x06\x01\x05\x05\a0\x01\x86\x18http://ocsp.digicert.com0@\x06\b+\x06\x01\x05\x05\a0\x02\x864http://cacerts.digicert.com/CloudFlareIncECCCA-2.crt0\f\x06\x03U\x1D\x13\x01\x01\xFF\x04\x020\x00&quot;&gt;,</span>
<span class="token comment">#      @timestamp=2020-02-14 10:53:04 +0900,</span>
<span class="token comment">#      @x509_entry=nil&gt;,</span>
<span class="token comment">#    @version=0&gt;,</span>
<span class="token comment">#  @precertificate=</span>
<span class="token comment">#   #&lt;OpenSSL::X509::Certificate</span>
<span class="token comment">#    subject=#&lt;OpenSSL::X509::Name CN=sni.cloudflaressl.com,O=Cloudflare\, Inc.,L=San Francisco,ST=CA,C=US&gt;,</span>
<span class="token comment">#    issuer=#&lt;OpenSSL::X509::Name CN=CloudFlare Inc ECC CA-2,O=CloudFlare\, Inc.,L=San Francisco,ST=CA,C=US&gt;,</span>
<span class="token comment">#    serial=#&lt;OpenSSL::BN 7053078753203853291268095395812724449&gt;,</span>
<span class="token comment">#    not_before=2020-02-14 00:00:00 UTC,</span>
<span class="token comment">#    not_after=2020-10-09 12:00:00 UTC&gt;&gt;</span>
</code></pre></div><h2 id="what-is-certstream"><a href="#what-is-certstream" class="header-anchor">#</a> What is CertStream</h2> <p><a href="https://certstream.calidog.io/" target="_blank" rel="noopener noreferrer">CertStream<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> is an Elixir app provides real-time CT log update stream.
CertStream is developed by <a href="https://twitter.com/fitblip" target="_blank" rel="noopener noreferrer">@fitblip<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> from <a href="https://twitter.com/calidogsec" target="_blank" rel="noopener noreferrer">@calidogsec<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <p>It collects CT logs from CT log servers and broadcasts parsed logs via WebSocket.</p> <p><img src="https://i.imgur.com/p8tyUdq.png" alt=""></p> <p>It works great, but recently I heard some complaints about it.</p> <blockquote class="twitter-tweet"><p lang="en" dir="ltr"><a href="https://twitter.com/calidogsec?ref_src=twsrc%5Etfw">@calidogsec</a> Is certstream having issues since a few days? Been getting very few certificates when using the service as well as certstream-server from GitHub. Anyone else seeing this? ðŸ˜°</p>â€” urlscan.io (@urlscanio) <a href="https://twitter.com/urlscanio/status/1224805357228380162?ref_src=twsrc%5Etfw">February 4, 2020</a></blockquote> <ul><li><a href="https://github.com/CaliDog/certstream-server/issues/22" target="_blank" rel="noopener noreferrer">Missing of certificates due to chunk calculation logic #22<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>So I dug into CertStream's code.</p> <h2 id="how-certstream-collects-ct-logs"><a href="#how-certstream-collects-ct-logs" class="header-anchor">#</a> How CertStream collects CT logs</h2> <ol><li>It gets a list of CT log servers from https://www.gstatic.com/ct/log_list/all_logs_list.json.</li> <li>It creates a process for each CT log server (by using <a href="https://hexdocs.pm/elixir/GenServer.html" target="_blank" rel="noopener noreferrer">GenServer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>).</li> <li>A process monitors a CT log server every 15 seconds.
<ol><li>A process is initialized with a state which has <code>url</code> (a URL of a CT log server) and <code>tree_size</code> (a tree size of a CT log server).</li> <li>A process gets the latest tree size and it gets entries and updates its <code>tree_size</code> if the latest tree size &gt; <code>tree_size</code></li></ol></li></ol> <h2 id="why-certsream-overlooks-logs"><a href="#why-certsream-overlooks-logs" class="header-anchor">#</a> Why CertSream overlooks logs</h2> <p>The issue lies in 3.2.</p> <p>CertStream sends a <code>get-entries</code> request to a CT log server and it doesn't count how many numbers of entries actually returned.</p> <p>It causes a problem because a CT log server doesn't always return requested number of entries.</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># Request 1,000 entries</span>
$ <span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token string">&quot;https://ct.googleapis.com/logs/xenon2020/ct/v1/get-entries?start=0&amp;end=999&quot;</span> <span class="token operator">|</span> jq <span class="token string">&quot;.entries | length&quot;</span>
<span class="token number">32</span>

$ <span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token string">&quot;https://ct.googleapis.com/logs/xenon2020/ct/v1/get-entries?start=20&amp;end=999&quot;</span> <span class="token operator">|</span> jq <span class="token string">&quot;.entries | length&quot;</span>
<span class="token number">12</span>

$ <span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token string">&quot;https://ct.googleapis.com/logs/xenon2020/ct/v1/get-entries?start=30&amp;end=999&quot;</span> <span class="token operator">|</span> jq <span class="token string">&quot;.entries | length&quot;</span>
<span class="token number">2</span>

$ <span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token string">&quot;https://ct.googleapis.com/logs/xenon2020/ct/v1/get-entries?start=32&amp;end=999&quot;</span> <span class="token operator">|</span> jq <span class="token string">&quot;.entries | length&quot;</span>
<span class="token number">32</span>
</code></pre></div><p>It means a CT log server has a specific threshold and in this case the threshold is 32.</p> <p>CertStream doesn't take this behavior into account so it overlooks some entries.</p> <div class="language-elixir extra-class"><pre class="language-elixir"><code>  <span class="token keyword">defp</span> <span class="token function">broadcast_updates</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> current_size<span class="token punctuation">)</span> <span class="token keyword">do</span>
    certificate_count <span class="token operator">=</span> <span class="token punctuation">(</span>current_size <span class="token operator">-</span> state<span class="token punctuation">[</span><span class="token atom symbol">:tree_size</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    certificates <span class="token operator">=</span> <span class="token module class-name">Enum</span><span class="token punctuation">.</span><span class="token function">to_list</span> <span class="token punctuation">(</span>current_size <span class="token operator">-</span> certificate_count<span class="token punctuation">)</span><span class="token operator">..</span>current_size <span class="token operator">-</span> <span class="token number">1</span>

    certificates
      <span class="token operator">|&gt;</span> <span class="token module class-name">Enum</span><span class="token punctuation">.</span><span class="token function">chunk_every</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span>
      <span class="token operator">|&gt;</span> <span class="token module class-name">Enum</span><span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span>
           <span class="token keyword">fn</span> ids <span class="token operator">-&gt;</span>
             update <span class="token operator">=</span> <span class="token function">fetch_update</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> <span class="token module class-name">List</span><span class="token punctuation">.</span><span class="token function">first</span><span class="token punctuation">(</span>ids<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token module class-name">List</span><span class="token punctuation">.</span><span class="token function">last</span><span class="token punctuation">(</span>ids<span class="token punctuation">)</span><span class="token punctuation">)</span>

             requested_count <span class="token operator">=</span> ids <span class="token operator">|&gt;</span> <span class="token module class-name">Enum</span><span class="token punctuation">.</span>count
             returned_count <span class="token operator">=</span> update <span class="token operator">|&gt;</span> <span class="token module class-name">Map</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;entries&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">|&gt;</span> <span class="token module class-name">Enum</span><span class="token punctuation">.</span>count
             <span class="token keyword">if</span> requested_count <span class="token operator">&gt;</span> returned_count <span class="token keyword">do</span>
               <span class="token module class-name">Logger</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Requested <span class="token interpolation"><span class="token delimiter punctuation">#{</span>requested_count<span class="token delimiter punctuation">}</span></span> entries but got <span class="token interpolation"><span class="token delimiter punctuation">#{</span>returned_count<span class="token delimiter punctuation">}</span></span> entries from https://<span class="token interpolation"><span class="token delimiter punctuation">#{</span>state<span class="token punctuation">[</span><span class="token atom symbol">:url</span><span class="token punctuation">]</span><span class="token delimiter punctuation">}</span></span>ct/v1/get-entries?start=<span class="token interpolation"><span class="token delimiter punctuation">#{</span><span class="token module class-name">List</span><span class="token punctuation">.</span><span class="token function">first</span><span class="token punctuation">(</span>ids<span class="token punctuation">)</span><span class="token delimiter punctuation">}</span></span>&amp;end=<span class="token interpolation"><span class="token delimiter punctuation">#{</span><span class="token module class-name">List</span><span class="token punctuation">.</span><span class="token function">last</span><span class="token punctuation">(</span>ids<span class="token punctuation">)</span><span class="token delimiter punctuation">}</span></span>.&quot;</span><span class="token punctuation">)</span>
             <span class="token keyword">end</span>

             update
               <span class="token operator">|&gt;</span> <span class="token module class-name">Map</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;entries&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
               <span class="token operator">|&gt;</span> <span class="token module class-name">Enum</span><span class="token punctuation">.</span><span class="token function">zip</span><span class="token punctuation">(</span>ids<span class="token punctuation">)</span>
               <span class="token operator">|&gt;</span> <span class="token module class-name">Enum</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">fn</span> <span class="token punctuation">{</span>entry<span class="token punctuation">,</span> cert_index<span class="token punctuation">}</span> <span class="token operator">-&gt;</span>
                 parsed_entry <span class="token operator">=</span> <span class="token module class-name">Certstream</span><span class="token punctuation">.</span><span class="token module class-name">CTParser</span><span class="token punctuation">.</span><span class="token function">parse_entry</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span>
                 parsed_entry
                   <span class="token operator">|&gt;</span> <span class="token module class-name">Map</span><span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span>
                        <span class="token punctuation">%</span><span class="token punctuation">{</span>
                          <span class="token atom symbol">:cert_index</span> <span class="token operator">=&gt;</span> cert_index<span class="token punctuation">,</span>
                          <span class="token atom symbol">:seen</span> <span class="token operator">=&gt;</span> <span class="token atom symbol">:os</span><span class="token punctuation">.</span><span class="token function">system_time</span><span class="token punctuation">(</span><span class="token atom symbol">:microsecond</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1_000_000</span><span class="token punctuation">,</span>
                          <span class="token atom symbol">:source</span> <span class="token operator">=&gt;</span> <span class="token punctuation">%</span><span class="token punctuation">{</span>
                            <span class="token atom symbol">:url</span> <span class="token operator">=&gt;</span> state<span class="token punctuation">[</span><span class="token atom symbol">:operator</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&quot;url&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                            <span class="token atom symbol">:name</span> <span class="token operator">=&gt;</span> state<span class="token punctuation">[</span><span class="token atom symbol">:operator</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&quot;description&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                          <span class="token punctuation">}</span><span class="token punctuation">,</span>
                          <span class="token atom symbol">:cert_link</span> <span class="token operator">=&gt;</span> <span class="token string">&quot;http://#{state[:operator][&quot;</span>url<span class="token string">&quot;]}ct/v1/get-entries?start=<span class="token interpolation"><span class="token delimiter punctuation">#{</span>cert_index<span class="token delimiter punctuation">}</span></span>&amp;end=<span class="token interpolation"><span class="token delimiter punctuation">#{</span>cert_index<span class="token delimiter punctuation">}</span></span>&quot;</span>
                        <span class="token punctuation">}</span>
                      <span class="token punctuation">)</span>
                 <span class="token keyword">end</span><span class="token punctuation">)</span>
               <span class="token operator">|&gt;</span> <span class="token module class-name">Certstream</span><span class="token punctuation">.</span><span class="token module class-name">ClientManager</span><span class="token punctuation">.</span>broadcast_to_clients
           <span class="token keyword">end</span><span class="token punctuation">)</span>
  <span class="token keyword">end</span>
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>18:29:17.886 [info]  GETing https://ct.googleapis.com/logs/argon2020/ct/v1/get-entries?start=344462138&amp;end=344462201

18:29:18.817 [info]  Requested 64 entries but got 6 entries from https://ct.googleapis.com/logs/argon2020/ct/v1/get-entries?start=344462138&amp;end=344462201.
</code></pre></div><h2 id="how-to-fix-the-issue"><a href="#how-to-fix-the-issue" class="header-anchor">#</a> How to fix the issue</h2> <p>This <a href="https://github.com/CaliDog/certstream-server/pull/24" target="_blank" rel="noopener noreferrer">PR<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> by <a href="https://twitter.com/fitblip" target="_blank" rel="noopener noreferrer">@fitblip<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> fixes the issue.</p> <p>Now CertStream takes a threshold (a.k.a <code>batch_size</code>) of a CT log server into account.</p> <div class="language-elixir extra-class"><pre class="language-elixir"><code>    <span class="token comment"># Attempt to fetch 1024 certificates, and see what the API returns. However</span>
    <span class="token comment"># many certs come back is what we should use as the batch size moving forward</span>
    <span class="token comment"># (at least in theory).</span>
    batch_size <span class="token operator">=</span> <span class="token function">http_request_with_retries</span><span class="token punctuation">(</span><span class="token string">&quot;https://<span class="token interpolation"><span class="token delimiter punctuation">#{</span>state<span class="token punctuation">[</span><span class="token atom symbol">:url</span><span class="token punctuation">]</span><span class="token delimiter punctuation">}</span></span>ct/v1/get-entries?start=0&amp;end=1024&quot;</span><span class="token punctuation">)</span>
                   <span class="token operator">|&gt;</span> <span class="token module class-name">Map</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;entries&quot;</span><span class="token punctuation">)</span>
                   <span class="token operator">|&gt;</span> <span class="token module class-name">Enum</span><span class="token punctuation">.</span>count

    <span class="token module class-name">Logger</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Worker <span class="token interpolation"><span class="token delimiter punctuation">#{</span>inspect <span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token delimiter punctuation">}</span></span> found batch size of <span class="token interpolation"><span class="token delimiter punctuation">#{</span>batch_size<span class="token delimiter punctuation">}</span></span>.&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>And it makes a retry when it doesn't get enough entries.</p> <div class="language-elixir extra-class"><pre class="language-elixir"><code>    <span class="token comment"># If we have *unequal* counts the API has returned less certificates than our initial batch</span>
    <span class="token comment"># heuristic. Drop the entires we retrieved and recurse to fetch others.</span>
    <span class="token keyword">if</span> entry_count <span class="token operator">!=</span> batch_count <span class="token keyword">do</span>
      <span class="token module class-name">Logger</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;We didn't retrieve all the entries for this batch, fetching missing <span class="token interpolation"><span class="token delimiter punctuation">#{</span>batch_count <span class="token operator">-</span> entry_count<span class="token delimiter punctuation">}</span></span> entries&quot;</span><span class="token punctuation">)</span>
      <span class="token function">fetch_and_broadcast_certs</span><span class="token punctuation">(</span>ids <span class="token operator">|&gt;</span> <span class="token module class-name">Enum</span><span class="token punctuation">.</span><span class="token function">drop</span><span class="token punctuation">(</span><span class="token module class-name">Enum</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span>entries<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span>
    <span class="token keyword">end</span>
</code></pre></div><h2 id="conclusion"><a href="#conclusion" class="header-anchor">#</a> Conclusion</h2> <p>In this post I described how CertStream works and how it is improved.</p> <p>It's a good opportunity to learn CT, CertStream and Elixir.</p> <p>Kudos to @fitblip, @ollieatnccgroup and @urlscanio.</p> <h2 id="references"><a href="#references" class="header-anchor">#</a> References</h2> <ul><li><a href="https://tools.ietf.org/html/rfc6962" target="_blank" rel="noopener noreferrer">RFC 6962: Certificate Transparency<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://medium.com/cali-dog-security/parsing-certificate-transparency-lists-like-a-boss-981716dc506" target="_blank" rel="noopener noreferrer">Parsing Certificate Transparency Logs Like a Boss<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://medium.com/cali-dog-security/introducing-certstream-3fc13bb98067" target="_blank" rel="noopener noreferrer">Introducing CertStream<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.c8db5b8a.js" defer></script><script src="/assets/js/2.551672f8.js" defer></script><script src="/assets/js/23.ed0bd195.js" defer></script>
  </body>
</html>
